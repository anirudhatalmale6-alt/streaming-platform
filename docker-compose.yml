version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: streaming-postgres
    environment:
      POSTGRES_USER: streaming
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-streaming_secret}
      POSTGRES_DB: streaming_platform
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - streaming-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U streaming -d streaming_platform"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching and pub/sub
  redis:
    image: redis:7-alpine
    container_name: streaming-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - streaming-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # SRS - Simple Realtime Server for RTMP/HLS
  srs:
    image: ossrs/srs:5
    container_name: streaming-srs
    volumes:
      - ./srs/srs.conf:/usr/local/srs/conf/srs.conf
      - ./storage/hls:/usr/local/srs/objs/nginx/html/hls
      - ./storage/recordings:/usr/local/srs/objs/nginx/html/recordings
    ports:
      - "1935:1935"   # RTMP
      - "1985:1985"   # HTTP API
      - "8080:8080"   # HTTP Server (HLS)
    networks:
      - streaming-network
    depends_on:
      - redis

  # Janus WebRTC Gateway
  janus:
    build:
      context: ./janus
      dockerfile: Dockerfile
    container_name: streaming-janus
    ports:
      - "8088:8088"   # HTTP
      - "8089:8089"   # HTTPS
      - "8188:8188"   # WebSocket
      - "8989:8989"   # Admin API
      - "10000-10100:10000-10100/udp"  # RTP
    networks:
      - streaming-network
    volumes:
      - ./janus/janus.jcfg:/opt/janus/etc/janus/janus.jcfg
      - ./janus/janus.plugin.streaming.jcfg:/opt/janus/etc/janus/janus.plugin.streaming.jcfg

  # Transcoding Service
  transcoder:
    build:
      context: ./transcoder
      dockerfile: Dockerfile
    container_name: streaming-transcoder
    environment:
      REDIS_URL: redis://redis:6379
      POSTGRES_URL: postgres://streaming:${POSTGRES_PASSWORD:-streaming_secret}@postgres:5432/streaming_platform
      SRS_API_URL: http://srs:1985
    volumes:
      - ./storage:/storage
    networks:
      - streaming-network
    depends_on:
      - redis
      - postgres
      - srs

  # Restream Service
  restream:
    build:
      context: ./restream
      dockerfile: Dockerfile
    container_name: streaming-restream
    environment:
      REDIS_URL: redis://redis:6379
      POSTGRES_URL: postgres://streaming:${POSTGRES_PASSWORD:-streaming_secret}@postgres:5432/streaming_platform
      FACEBOOK_APP_ID: ${FACEBOOK_APP_ID}
      FACEBOOK_APP_SECRET: ${FACEBOOK_APP_SECRET}
      YOUTUBE_CLIENT_ID: ${YOUTUBE_CLIENT_ID}
      YOUTUBE_CLIENT_SECRET: ${YOUTUBE_CLIENT_SECRET}
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
    networks:
      - streaming-network
    depends_on:
      - redis
      - postgres

  # Linear Playout Engine
  playout:
    build:
      context: ./playout
      dockerfile: Dockerfile
    container_name: streaming-playout
    environment:
      REDIS_URL: redis://redis:6379
      POSTGRES_URL: postgres://streaming:${POSTGRES_PASSWORD:-streaming_secret}@postgres:5432/streaming_platform
      SRS_RTMP_URL: rtmp://srs:1935/live
    volumes:
      - ./storage:/storage
    networks:
      - streaming-network
    depends_on:
      - redis
      - postgres
      - srs

  # Backend API
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: streaming-api
    environment:
      NODE_ENV: production
      PORT: 3000
      REDIS_URL: redis://redis:6379
      POSTGRES_URL: postgres://streaming:${POSTGRES_PASSWORD:-streaming_secret}@postgres:5432/streaming_platform
      JWT_SECRET: ${JWT_SECRET:-your_jwt_secret_here}
      SRS_API_URL: http://srs:1985
      JANUS_API_URL: http://janus:8088/janus
      FACEBOOK_APP_ID: ${FACEBOOK_APP_ID}
      FACEBOOK_APP_SECRET: ${FACEBOOK_APP_SECRET}
      YOUTUBE_CLIENT_ID: ${YOUTUBE_CLIENT_ID}
      YOUTUBE_CLIENT_SECRET: ${YOUTUBE_CLIENT_SECRET}
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
    ports:
      - "3000:3000"
    networks:
      - streaming-network
    depends_on:
      - redis
      - postgres
      - srs
      - janus

  # Frontend Dashboard
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: streaming-dashboard
    environment:
      REACT_APP_API_URL: ${API_URL:-http://localhost:3000}
      REACT_APP_HLS_URL: ${HLS_URL:-http://localhost:8080}
      REACT_APP_WS_URL: ${WS_URL:-ws://localhost:8188}
    ports:
      - "80:80"
    networks:
      - streaming-network
    depends_on:
      - api

  # Nginx Reverse Proxy (optional for production)
  nginx:
    image: nginx:alpine
    container_name: streaming-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    ports:
      - "443:443"
    networks:
      - streaming-network
    depends_on:
      - api
      - dashboard
      - srs
    profiles:
      - production

networks:
  streaming-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
